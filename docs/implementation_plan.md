# Implementation Plan - Fix Tool Argument Parsing

## Goal Description
Fix argument parsing issues in `ppt_add_bullet_list.py` and `ppt_add_text_box.py` where strict validation fails against Agent K2's usage pattern. The agent often omits `--size` or puts size information in `--position`. The fix involves making `--size` optional and intelligently extracting dimensions from `--position` if needed.

## User Review Required
> [!NOTE]
> This change relaxes the strict## Fix 3: Agent K2 Tool Argument Errors (Round 2)
### Problem
`ppt_add_bullet_list.py` and `ppt_add_text_box.py` failed due to strict argument parsing (missing `--size` or size in `--position`).

### Proposed Changes
#### [MODIFY] [ppt_add_bullet_list.py](file:///home/project/powerpoint-agent-tools/tools/ppt_add_bullet_list.py)
- Make `--size` optional.
- Merge dimensions from `--position` if missing in `--size`.

#### [MODIFY] [ppt_add_text_box.py](file:///home/project/powerpoint-agent-tools/tools/ppt_add_text_box.py)
- Make `--size` optional.
- Merge dimensions from `--position` if missing in `--size`.

### Verification Plan
- Create `repro_k2_round2.py` to simulate the failing calls.
- Verify successful execution.

## Fix 4: Agent K2 Tool Argument Errors (Round 3)
### Problem
1. `ppt_add_shape.py` and `ppt_add_chart.py`: `ValueError: Size must have at least width or height`.
2. `ppt_add_text_box.py`: `unrecognized arguments: true` (boolean flag misuse).
3. `ppt_set_footer.py`: `unrecognized arguments: true false` (boolean flag misuse).

### Proposed Changes
#### [MODIFY] [ppt_add_shape.py](file:///home/project/powerpoint-agent-tools/tools/ppt_add_shape.py)
- Make `--size` optional.
- Merge dimensions from `--position` if missing in `--size`.

#### [MODIFY] [ppt_add_chart.py](file:///home/project/powerpoint-agent-tools/tools/ppt_add_chart.py)
- Make `--size` optional.
- Merge dimensions from `--position` if missing in `--size`.

#### [MODIFY] [ppt_add_text_box.py](file:///home/project/powerpoint-agent-tools/tools/ppt_add_text_box.py)
- Update `--bold` and `--italic` to accept optional string values (e.g., "true", "false").

#### [MODIFY] [ppt_set_footer.py](file:///home/project/powerpoint-agent-tools/tools/ppt_set_footer.py)
- Update `--show-number` and `--show-date` to accept optional string values.

### Verification Plan
- Create `repro_k2_round3.py` to simulate the failing calls.
- Verify successful execution.

## Fix 5: Agent K2 Tool Argument Errors (Round 4)
### Problem
Errors persist on Slide 10 because the agent omits dimensions entirely (or partially) from both `--size` and `--position`.
- `ppt_add_text_box.py`: `ValueError: Text box must have explicit width and height`
- `ppt_add_shape.py`: `ValueError: Size must have at least width or height`

### Proposed Changes
Implement default dimensions if missing in both `--size` and `--position`.

#### [MODIFY] [ppt_add_text_box.py](file:///home/project/powerpoint-agent-tools/tools/ppt_add_text_box.py)
- If `width` missing: default to "40%"
- If `height` missing: default to "20%"

#### [MODIFY] [ppt_add_shape.py](file:///home/project/powerpoint-agent-tools/tools/ppt_add_shape.py)
- If `width` missing: default to "20%"
- If `height` missing: default to "20%"

#### [MODIFY] [ppt_add_chart.py](file:///home/project/powerpoint-agent-tools/tools/ppt_add_chart.py)
- If `width` missing: default to "50%"
- If `height` missing: default to "50%"

#### [MODIFY] [ppt_add_bullet_list.py](file:///home/project/powerpoint-agent-tools/tools/ppt_add_bullet_list.py)
- If `width` missing: default to "80%"
- If `height` missing: default to "50%"

### Verification Plan
- Create `repro_k2_round4.py` simulating calls with NO dimensions.
- Verify successful execution.

#### [MODIFY] [ppt_add_text_box.py](file:///home/project/powerpoint-agent-tools/tools/ppt_add_text_box.py)
- Make `--size` optional in `argparse` (remove `required=True`).
- In `main()`:
    - Initialize `args.size` to `{}` if None.
    - Check if `width` and `height` exist in `args.position`.
    - If present in position but missing in size, copy them to `args.size`.

## Verification Plan

### Automated Tests
- Create a test script `repro_k2_round2.py` that calls the tools with the problematic arguments (missing size, or size in position).
- Verify that the tools execute successfully and the elements are added with correct dimensions.

### Manual Verification
- Run `agent_k2.sh` (or the relevant parts) to ensure it proceeds past the previous failure points.

## Fix 6: Agent K2 Tool Error (Round 6)
### Problem
`ppt_export_images.py` fails with "Export completed but no image files found" even though LibreOffice exits successfully. This indicates a mismatch between expected and actual filenames generated by LibreOffice.

### Proposed Changes
#### [MODIFY] [ppt_export_images.py](file:///home/project/powerpoint-agent-tools/tools/ppt_export_images.py)
- Update file finding logic to be more robust.
- Instead of predicting exact names (e.g., `_01.png`), list all files in the output directory matching the pattern `filename*.<ext>`.
- Sort the found files to ensure correct order.
- Rename them to the expected `slide_XXX.<ext>` format.

### Verification Plan
- Run `ppt_export_images.py` manually on the generated presentation.
## Fix 7: Validation False Positive (Slide 0 Title)
### Problem
`ppt_validate_presentation.py` reports "Slides without titles: [0]" even though Slide 0 has a title. This is because the tool only checks for `PP_PLACEHOLDER.TITLE` (Type 1), but the Title Slide layout uses `PP_PLACEHOLDER.CENTER_TITLE` (Type 3).

### Proposed Changes
#### [MODIFY] [core/powerpoint_agent_core.py](file:///home/project/powerpoint-agent-tools/core/powerpoint_agent_core.py)
- Update `validate_presentation` method to check for both Type 1 (TITLE) and Type 3 (CENTER_TITLE).

### Verification Plan
- Run `debug_slide0.py` to confirm placeholder type.
- Run `ppt_validate_presentation.py` on the generated presentation and verify no title error for Slide 0.

## Fix 8: Incomplete Image Export
### Problem
`ppt_export_images.py` only exports 1 slide (the first one) when using `soffice --convert-to png`. This is likely a limitation or behavior of the LibreOffice CLI for PNG export.

### Proposed Changes
#### [MODIFY] [tools/ppt_export_images.py](file:///home/project/powerpoint-agent-tools/tools/ppt_export_images.py)
- Implement a PDF-intermediate workflow:
    1. Export PPTX to PDF (using existing logic/command).
    2. Use `pdftoppm` (from `poppler-utils`) to convert PDF to PNGs.
    3. Fallback to `soffice` direct export if `pdftoppm` is missing.
- This ensures all slides are exported reliably.

### Verification Plan
- Run `ppt_export_images.py` on the generated presentation.
- Verify that 12 images are created (`slide_001.png` to `slide_012.png`).

## Fix 9: Silent Failure in `set_title` (Slide 0)
### Problem
`ppt_set_title.py` reported success on Slide 0, but the title was not actually set. This is because `PowerPointAgent.set_title` only looks for `PP_PLACEHOLDER.TITLE` (Type 1), ignoring `PP_PLACEHOLDER.CENTER_TITLE` (Type 3) which is used on Title Slides.

### Proposed Changes
#### [MODIFY] [core/powerpoint_agent_core.py](file:///home/project/powerpoint-agent-tools/core/powerpoint_agent_core.py)
- Update `set_title` method to accept `CENTER_TITLE` (Type 3) as a valid title placeholder.

### Verification Plan
- Run `ppt_set_title.py` on Slide 0 of the generated presentation.
- Run `ppt_set_title.py` on Slide 0 of the generated presentation.
- Run `debug_slide0.py` to confirm the text is now set.

## Fix 10: Accessibility Checker False Positive (Slide 0 Title)
### Problem
`ppt_check_accessibility.py` (via `AccessibilityChecker.check_presentation`) still reports "missing_titles: [0]" because it also hardcodes the check for `PP_PLACEHOLDER.TITLE` (Type 1), ignoring `CENTER_TITLE` (Type 3).

### Proposed Changes
#### [MODIFY] [core/powerpoint_agent_core.py](file:///home/project/powerpoint-agent-tools/core/powerpoint_agent_core.py)
- Update `AccessibilityChecker.check_presentation` to check for both Type 1 and Type 3 placeholders.

### Verification Plan
- Run `ppt_check_accessibility.py` on the generated presentation.
- Verify `missing_titles` is empty.

## Fix 13: Missing JSON Output in Image Export
### Problem
`ppt_export_images.py` outputs `null` in the log because the new PDF-to-image workflow in `export_images` does not return a result dictionary (it implicitly returns `None`).

### Proposed Changes
#### [MODIFY] [tools/ppt_export_images.py](file:///home/project/powerpoint-agent-tools/tools/ppt_export_images.py)
- Extract the logic for scanning the output directory and building the result dictionary into a helper function `_scan_and_build_result`.
- Call this helper at the end of `export_images` for both the PDF workflow and the fallback direct workflow.

### Verification Plan
- Run `ppt_export_images.py` on the generated presentation.
- Verify it outputs a valid JSON dictionary instead of `null`.

# System Prompt Updates

## Goal
Update `AGENT_SYSTEM_PROMPT_enhanced.md` to reflect best practices and tool capabilities identified during the final quality check.

## Proposed Changes
#### [MODIFY] [AGENT_SYSTEM_PROMPT_enhanced.md](file:///home/project/powerpoint-agent-tools/AGENT_SYSTEM_PROMPT_enhanced.md)

1.  **Tool Signature Update:**
    -   Locate `ppt_add_bullet_list.py` in the "Domain 3: Text & Content" table.
    -   Update "Critical Arguments" to include `--font-name NAME`, `--font-size N`, `--color HEX`.

2.  **Output Parsing Best Practice:**
    -   Add to "JSON-First I/O Standard" section:
        > - **Robust Parsing**: When extracting values from JSON output (e.g., `slide_count`), use precise keys. Example: `ppt_get_info.py` returns `{"slide_count": 12}`, not `{"slides": 12}`.

3.  **Title Slide Support:**
    -   Add to "Domain 2: Slide Management" section (under `ppt_set_title.py` or as a general note):
        > - **Title Slide Handling**: `ppt_set_title.py` and `ppt_validate_presentation.py` automatically handle both standard `TITLE` and `CENTER_TITLE` placeholders found on Title Slides.

4.  **Font Consistency:**
    -   Add to "Visual Design Excellence Framework" -> "Typography":
        > - **Font Inheritance**: When adding content (lists, text), rely on the theme's default font (by omitting `--font-name`) unless a specific override is visually required.

## Verification Plan
- Review the modified `AGENT_SYSTEM_PROMPT_enhanced.md` to ensure changes are correctly applied and formatting is preserved.

## Fix 11: Broken Slide Count Extraction in Script
### Problem
`agent_k2.sh` fails to extract the slide count because it greps for `"slides":` but `ppt_get_info.py` outputs `"slide_count":`.

### Proposed Changes
#### [MODIFY] [agent_k2.sh](file:///home/project/powerpoint-agent-tools/agent_k2.sh)
- Update the grep pattern to match `"slide_count":`.

### Verification Plan
- Run the grep command manually on the output of `ppt_get_info.py`.

## Fix 12: Inconsistent Fonts (Arial vs Calibri)
### Problem
`PowerPointAgent.add_bullet_list` forces the font to "Arial" when `bullet_style="bullet"`, overriding the presentation's theme or the `font_name` argument (if it were passed down, which it seems to be via `formatting` in the log, but the code snippet showed it setting `p.font.name = "Arial"` directly).

### Proposed Changes
#### [MODIFY] [core/powerpoint_agent_core.py](file:///home/project/powerpoint-agent-tools/core/powerpoint_agent_core.py)
- Remove the hardcoded `p.font.name = "Arial"` in `add_bullet_list`.
- Ensure the font set by `formatting` (or the default) is respected.

### Verification Plan
- Run `ppt_add_bullet_list.py` on a test slide.
- Verify the font is not forced to Arial.
