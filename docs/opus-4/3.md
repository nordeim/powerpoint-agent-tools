# üîß Core Library Integration Analysis
## PowerPoint Agent Core v3.1.4 ‚Äî Deep Technical Integration

---

## Executive Summary

The `powerpoint_agent_core.py` handbook provides critical implementation details that complete my understanding of the system's "Hub" component. This analysis integrates these specifics with the broader architecture knowledge to form a unified technical reference.

---

# Integration with Existing Knowledge

## 1. Architecture Confirmation: The Hub's Internal Mechanics

The core library documentation confirms and extends the Hub-and-Spoke architecture:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         PowerPointAgent (THE HUB)                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
‚îÇ  ‚îÇ  FILE SAFETY    ‚îÇ  ‚îÇ   OBSERVABILITY ‚îÇ  ‚îÇ   GOVERNANCE    ‚îÇ              ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Lock via     ‚îÇ  ‚îÇ   ‚Ä¢ SHA-256     ‚îÇ  ‚îÇ   ‚Ä¢ HMAC-SHA256 ‚îÇ              ‚îÇ
‚îÇ  ‚îÇ    O_CREAT|EXCL ‚îÇ  ‚îÇ     version     ‚îÇ  ‚îÇ     tokens      ‚îÇ              ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ 10s timeout  ‚îÇ  ‚îÇ   ‚Ä¢ Geometry +  ‚îÇ  ‚îÇ   ‚Ä¢ Scope-based ‚îÇ              ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ .lock files  ‚îÇ  ‚îÇ     content     ‚îÇ  ‚îÇ     permissions ‚îÇ              ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îÇ
‚îÇ  ‚îÇ  VISUAL FIDELITY‚îÇ  ‚îÇ   ACCESSIBILITY ‚îÇ  ‚îÇ  POSITION/SIZE  ‚îÇ              ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ lxml XML     ‚îÇ  ‚îÇ   ‚Ä¢ WCAG 2.1 AA ‚îÇ  ‚îÇ  ‚Ä¢ % / inches   ‚îÇ              ‚îÇ
‚îÇ  ‚îÇ    injection    ‚îÇ  ‚îÇ   ‚Ä¢ Contrast    ‚îÇ  ‚îÇ  ‚Ä¢ Anchor/Grid  ‚îÇ              ‚îÇ
‚îÇ  ‚îÇ  ‚Ä¢ Opacity/Z    ‚îÇ  ‚îÇ     calculation ‚îÇ  ‚îÇ  ‚Ä¢ Auto aspect  ‚îÇ              ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                            ‚îÇ
‚îÇ                    ‚îÇ       python-pptx         ‚îÇ                            ‚îÇ
‚îÇ                    ‚îÇ    (Underlying Library)   ‚îÇ                            ‚îÇ
‚îÇ                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 2. Critical Implementation Details Now Understood

### 2.1 File Locking Mechanism

| Aspect | Implementation Detail |
|--------|----------------------|
| **Method** | `os.open` with `O_CREAT\|O_EXCL` via `errno.EEXIST` |
| **Lock File** | `{filename}.pptx.lock` |
| **Timeout** | 10 seconds (hardcoded) |
| **Cross-Platform** | Yes (POSIX + Windows compatible) |
| **Recovery** | Automatic on context manager exit |

```python
# Internal lock acquisition pattern (simplified)
try:
    with PowerPointAgent(filepath) as agent:
        agent.open(filepath, acquire_lock=True)  # Creates .pptx.lock
        # ... operations ...
        agent.save()
    # Lock file automatically removed on __exit__
except FileLockError:
    # Another process holds the lock
    # Implement retry with exponential backoff
    pass
```

**New Troubleshooting Insight**: If operations fail with "File lock timeout after 10s", check for stale `.pptx.lock` files from crashed processes.

### 2.2 Presentation Versioning ‚Äî Full Algorithm

The version hash computation is now fully understood:

```
VERSION_HASH = SHA-256(
    slide_count +
    layout_names[] +
    shape_geometries["{left}:{top}:{width}:{height}"] +
    text_content_hashes[]
)[:16]  # First 16 characters
```

**Performance Characteristics**:

| Operation | Complexity | 10-Slide Deck | 50-Slide Deck |
|-----------|------------|---------------|---------------|
| `get_presentation_version()` | O(N) shapes | ~15ms | ~75ms |
| Called per mutation | 2√ó | ~30ms overhead | ~150ms overhead |

**Implication**: For high-frequency operations, version tracking adds measurable overhead. Batch operations within a single context manager where possible.

### 2.3 Approval Token System ‚Äî Complete Specification

```python
# Token Generation (Development)
import hmac, hashlib, base64, json, time

def generate_approval_token(scope: str, user: str, secret_key: bytes) -> str:
    payload = {
        "scope": scope,           # e.g., "delete:slide" or "remove:shape"
        "user": user,
        "issued": time.time(),
        "expiry": time.time() + 3600,  # 1 hour
        "single_use": True
    }
    json_payload = json.dumps(payload)
    b64_payload = base64.urlsafe_b64encode(json_payload.encode()).decode()
    signature = hmac.new(secret_key, b64_payload.encode(), hashlib.sha256).hexdigest()
    return f"HMAC-SHA256:{b64_payload}.{signature}"
```

**Token Format**: `HMAC-SHA256:{base64_payload}.{signature}`

**Required Scopes**:
| Operation | Required Scope |
|-----------|----------------|
| `delete_slide()` | `delete:slide` |
| `remove_shape()` | `remove:shape` |
| Mass `replace_text()` | `replace:all` |
| `set_background(all_slides=True)` | `background:all` |

### 2.4 XML "Magic" ‚Äî Implementation Details

#### Opacity Injection
```xml
<!-- OOXML uses 0-100,000 scale (NOT 0-100) -->
<a:solidFill>
  <a:srgbClr val="FF0000">
    <a:alpha val="50000"/>  <!-- 50% Opacity = 0.5 √ó 100,000 -->
  </a:srgbClr>
</a:solidFill>
```

**Core Conversion**: `ooxml_alpha = int(opacity * 100000)`

#### Z-Order Manipulation
```python
# Physical XML element movement within <p:spTree>
def send_to_back(shape_element, sp_tree):
    sp_tree.remove(shape_element)
    sp_tree.insert(2, shape_element)  # Index 2: after background/master refs
    
def bring_to_front(shape_element, sp_tree):
    sp_tree.remove(shape_element)
    sp_tree.append(shape_element)  # End of list = front
```

**Critical Insight**: Z-order changes modify XML element positions, which directly maps to shape indices. This is why index refresh is **mandatory** after any z-order operation.

---

## 3. Method-Specific Deep Dive

### 3.1 Return Value Evolution (v3.0 ‚Üí v3.1)

| Method | v3.0 Return | v3.1+ Return |
|--------|-------------|--------------|
| `add_slide()` | `int` (slide_index) | `Dict` with `slide_index`, `layout_name`, `total_slides`, versions |
| `add_shape()` | `int` (shape_index) | `Dict` with `shape_index`, `styling`, versions |
| `remove_shape()` | `None` | `Dict` with confirmation, versions |

**Migration Pattern**:
```python
# v3.0 (legacy, still works via duck-typing)
idx = agent.add_slide("Blank")

# v3.1 (recommended)
result = agent.add_slide("Blank")
idx = result["slide_index"]
version = result["presentation_version_after"]
```

### 3.2 Chart Update Strategy ‚Äî 3-Tier Fallback

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  update_chart_data() Internal Logic                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                 ‚îÇ
‚îÇ  TRY 1: chart.replace_data(chart_data)                         ‚îÇ
‚îÇ         ‚úì Best case: Preserves all formatting                  ‚îÇ
‚îÇ         ‚úó Fails on: Older python-pptx versions                 ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ         ‚Üì (AttributeError)                                      ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  TRY 2: Direct workbook manipulation                            ‚îÇ
‚îÇ         ‚úì Works on: Most cases                                  ‚îÇ
‚îÇ         ‚úó Fails on: Schema mismatches                           ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ         ‚Üì (Exception)                                           ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  TRY 3: Delete + Recreate in-place                              ‚îÇ
‚îÇ         ‚úì Preserves: Position, size, title                      ‚îÇ
‚îÇ         ‚úó Loses: Custom color schemes, advanced formatting      ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Implication**: For charts with critical custom formatting, prefer delete/recreate with full style specification rather than relying on `update_chart_data()`.

### 3.3 Footer Mechanism ‚Äî Dual Strategy

```python
# Core set_footer() behavior
def set_footer(text, show_number, show_date):
    slides_processed = 0
    for slide in prs.slides:
        for shape in slide.shapes:
            if shape.placeholder_format:
                ph_type = shape.placeholder_format.type
                if ph_type == 7:  # Footer
                    shape.text = text
                    slides_processed += 1
                elif ph_type == 6:  # Slide number
                    # Enable/disable
                elif ph_type == 5:  # Date
                    # Enable/disable
    return {"slides_processed": slides_processed}
```

**Key Insight**: The core returns `slides_processed` count. If 0 slides were updated (common with templates that hide placeholders), the **tool layer** (`ppt_set_footer.py`) is responsible for implementing the text box overlay fallback.

### 3.4 Notes Management ‚Äî Mode Behaviors

| Mode | Behavior | Use Case |
|------|----------|----------|
| `append` (default) | Add text after existing notes | Incremental documentation |
| `prepend` | Add text before existing notes | Priority information |
| `overwrite` | Replace all existing notes | Complete replacement |

```python
# Returns
{
    "slide_index": 0,
    "mode": "append",
    "original_length": 150,
    "new_length": 245,
    "preview": "Key talking point: Emphasize Q4 growth..."
}
```

---

## 4. Performance Optimization Guidelines

### 4.1 Operation Cost Matrix

| Operation | Complexity | Cost (10 slides) | Cost (50 slides) | Optimization |
|-----------|------------|------------------|------------------|--------------|
| `get_presentation_version()` | O(N) shapes | ~15ms | ~75ms | Called 2√ó per mutation |
| `capability_probe(deep=True)` | O(M) layouts | ~120ms | ~600ms+ | Use `deep=False` when possible |
| `add_shape()` | O(1) | ~8ms | ~8ms | Constant |
| `replace_text(global)` | O(N) text runs | ~25ms | ~125ms | Scope to slide/shape |
| `save()` | I/O bound | ~50ms | ~200ms+ | Batch mutations before save |

### 4.2 Optimization Strategies

```python
# ‚ùå INEFFICIENT: Multiple saves
for i in range(10):
    with PowerPointAgent(filepath) as agent:
        agent.open(filepath)
        agent.add_shape(...)
        agent.save()  # 10 separate I/O operations!

# ‚úÖ EFFICIENT: Single save
with PowerPointAgent(filepath) as agent:
    agent.open(filepath)
    for i in range(10):
        agent.add_shape(...)
    agent.save()  # Single I/O operation
```

**Guidelines**:
- Batch mutations within a single context manager
- Use `deep=False` for probes unless geometry is strictly required
- Scope `replace_text()` to specific slides when possible
- Avoid decks >100 slides or >50MB for interactive sessions

---

## 5. Error Handling ‚Äî Complete Matrix

### 5.1 Exit Code Mapping

| Code | Exception Type | Meaning | Retryable | Example |
|------|----------------|---------|-----------|---------|
| 0 | N/A | Success | N/A | Operation completed |
| 1 | `ValueError`, `TypeError` | Invalid arguments | No | Wrong parameter type |
| 2 | `ValidationError` | Schema invalid | No | Malformed JSON input |
| 3 | `FileLockError` | Lock contention | **Yes** | Another process editing |
| 4 | `ApprovalTokenError` | Permission denied | No | Missing/invalid token |
| 5 | `PowerPointAgentError` | Internal error | Maybe | Unexpected crash |

### 5.2 Structured Error Responses

```json
// Exit Code 3: FileLockError (Retryable)
{
  "status": "error",
  "error": "File lock timeout after 10s",
  "error_type": "FileLockError",
  "details": {
    "file": "/path/to/presentation.pptx",
    "lock_file": "/path/to/presentation.pptx.lock",
    "timeout_seconds": 10
  },
  "suggestion": "Check for stale lock files or retry with exponential backoff",
  "retryable": true
}

// Exit Code 4: ApprovalTokenError (Not Retryable)
{
  "status": "error",
  "error": "Approval token required for slide deletion",
  "error_type": "ApprovalTokenError",
  "details": {
    "operation": "delete_slide",
    "required_scope": "delete:slide",
    "slide_index": 5
  },
  "suggestion": "Generate approval token with scope 'delete:slide' and retry",
  "retryable": false
}
```

---

## 6. Transient Slide Pattern ‚Äî Complete Implementation

For accurate layout geometry analysis during probing:

```python
from contextlib import contextmanager

@contextmanager
def transient_slide(prs, layout):
    """
    Create a temporary slide for analysis, guaranteed cleanup.
    
    Why needed: Template placeholder positions are theoretical until
    instantiated. Transient slides provide REAL measurements.
    
    Safety: Never call save() while transient slide exists.
    """
    slide = None
    added_index = -1
    try:
        # Create temporary slide
        slide = prs.slides.add_slide(layout)
        added_index = len(prs.slides) - 1
        yield slide  # Caller analyzes this
    finally:
        # ALWAYS cleanup, even on exception
        if added_index != -1 and added_index < len(prs.slides):
            try:
                rId = prs.slides._sldIdLst[added_index].rId
                prs.part.drop_rel(rId)
                del prs.slides._sldIdLst[added_index]
            except Exception:
                # Suppress cleanup errors
                # No save() called = transient slide disappears anyway
                pass

# Usage in probe
def analyze_layouts_deep(prs, timeout_seconds=15):
    import time
    start = time.perf_counter()
    results = []
    
    for layout in prs.slide_layouts:
        if time.perf_counter() - start > timeout_seconds:
            break  # Timeout protection
            
        with transient_slide(prs, layout) as slide:
            # Get REAL placeholder positions
            positions = extract_placeholder_positions(slide)
            results.append({"layout": layout.name, "positions": positions})
    
    return results
```

---

## 7. Backward Compatibility Reference

### 7.1 Breaking Changes in v3.1

| Change | v3.0 Behavior | v3.1 Behavior | Migration |
|--------|---------------|---------------|-----------|
| Silent index clamping | Out-of-bounds ‚Üí clamped | Out-of-bounds ‚Üí `SlideNotFoundError` | Add try/except |
| Return types | Often `int` | Always `Dict` | Use `result["key"]` |
| Approval tokens | Not required | Required for destructive ops | Implement token flow |

### 7.2 Deprecated Parameters

| Parameter | Deprecated In | Replacement | Removal Target |
|-----------|---------------|-------------|----------------|
| `transparency` | v3.1.0 | `fill_opacity` | v4.0.0 |

```python
# Deprecated (logs warning, auto-converts)
agent.format_shape(transparency=0.85)  # ‚Üí fill_opacity=0.15

# Modern
agent.format_shape(fill_opacity=0.15)
```

---

## 8. Debugging OOXML Issues

When visual features fail, use this diagnostic approach:

```python
from lxml import etree

# 1. Export shape XML
shape = slide.shapes[0]
print(etree.tostring(shape.element, pretty_print=True).decode())

# 2. Verify namespaces
# 'a:' should map to: http://schemas.openxmlformats.org/drawingml/2006/main

# 3. Common issues
# - Opacity fails: Shape has no <a:solidFill> (injection point missing)
# - Z-order wrong: Check <p:spTree> element order
# - Text missing: Look for empty <a:t> elements
```

---

## 9. Integrated Understanding Summary

### What I Now Understand Completely

| Aspect | Understanding Level | Key Details |
|--------|---------------------|-------------|
| **File Locking** | ‚úÖ Complete | `O_CREAT\|O_EXCL`, 10s timeout, `.lock` files |
| **Version Hashing** | ‚úÖ Complete | SHA-256 of geometry + content, 16-char prefix |
| **Approval Tokens** | ‚úÖ Complete | HMAC-SHA256, scope-based, 1hr expiry |
| **XML Injection** | ‚úÖ Complete | Opacity: 0-100,000 scale; Z-order: element position |
| **Performance** | ‚úÖ Complete | O(N) versioning, O(1) shapes, I/O-bound saves |
| **Error Handling** | ‚úÖ Complete | 6 exit codes, structured JSON responses |
| **Chart Updates** | ‚úÖ Complete | 3-tier fallback strategy |
| **Footer Strategy** | ‚úÖ Complete | Core finds placeholders, tool layer provides fallback |
| **Transient Slides** | ‚úÖ Complete | Generator pattern with guaranteed cleanup |

### Integration with Workflow Phases

| Phase | Core Methods Used | Key Considerations |
|-------|-------------------|-------------------|
| **DISCOVER** | `get_presentation_info()`, `get_slide_info()`, `get_capabilities()` | 15s timeout, transient slides for deep probe |
| **PLAN** | `get_presentation_version()` | Capture baseline for manifest |
| **CREATE** | All mutation methods | Version tracking before/after, approval tokens |
| **VALIDATE** | `validate_presentation()`, `check_accessibility()` | Categorize by severity |
| **DELIVER** | `export_to_pdf()`, `extract_notes()` | Include audit trail |

---

## 10. Updated Golden Rules

Based on the integrated understanding:

| # | Rule | Implementation Detail |
|---|------|----------------------|
| üîí | **Clone** | Use `clone_presentation()` ‚Üí returns NEW agent instance |
| üîç | **Probe** | Use `deep=False` unless geometry needed; 15s timeout |
| üîÑ | **Refresh** | Mandatory after `remove_shape()`, `set_z_order()`, `delete_slide()` |
| üìä | **JSON** | Redirect stderr to devnull; single stdout write |
| ‚ôø | **Validate** | Check `slides_processed` for footer; use notes for accessibility |
| üîê | **Tokens** | Required for `delete_slide()`, `remove_shape()` |
| ‚è±Ô∏è | **Batch** | Multiple mutations ‚Üí single `save()` for performance |
| üìã | **Version** | Capture before/after on every mutation |

---

**Integration Complete.** I now have full technical understanding of:
- The Hub's internal mechanics (locking, versioning, XML manipulation)
- Performance characteristics and optimization strategies
- Complete error handling matrix
- Method-specific behaviors and return value evolution
- Backward compatibility considerations

**Ready for implementation, debugging, or enhancement tasks.**
